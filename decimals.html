<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f0f2f5; }
        .problem-container { border: 3px solid #333; padding: 30px; border-radius: 12px; background: #ffffff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 350px; }
        .instructions { font-size: 14px; margin-bottom: 20px; padding: 10px; background: #e7f3ff; border-left: 4px solid #2196f3; }
        
        /* Grid Layout */
        .math-table { display: grid; grid-template-columns: repeat(6, 40px); gap: 2px; align-items: center; justify-content: center; margin-bottom: 20px; }
        .cell { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid #ddd; }
        .no-border { border: none; }
        .decimal-cell { font-weight: bold; color: #d32f2f; border: none; width: 10px; }
        
        /* Shifting logic */
        #row2-wrapper { grid-column: 1 / span 6; display: grid; grid-template-columns: repeat(6, 40px); gap: 2px; transition: transform 0.2s ease; }
        .controls { display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px; }
        
        .line { grid-column: 1 / span 6; height: 3px; background: #333; margin: 5px 0; }
        
        /* Inputs */
        input.digit-input { width: 30px; height: 30px; font-size: 20px; text-align: center; border: 2px solid #ccc; border-radius: 4px; outline: none; }
        input.correct { border-color: #4caf50 !important; background-color: #e8f5e9; }
        input.incorrect { border-color: #f44336 !important; background-color: #ffebee; }
        input:disabled { background-color: #eee; cursor: not-allowed; border-color: #ddd; }

        /* Annotation row for carries / borrows */
        .annotation-row { display: grid; grid-template-columns: repeat(6, 40px); gap: 2px; margin-bottom: 8px; justify-content: center; }
        .note-input { width: 30px; height: 24px; font-size: 14px; text-align: center; border: 1px dashed #999; color: #666; border-radius: 4px; }
        .note-input.active { border-style: solid; border-color: #2196f3; }
        .note-input.correct { border-color: #4caf50 !important; background-color: #e8f5e9; }
        .note-input.incorrect { border-color: #f44336 !important; background-color: #ffebee; }
        .borrowed { text-decoration: line-through; color: #999 !important; }

        button { padding: 8px 16px; cursor: pointer; background: #2196f3; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:disabled { background: #ccc; }
        .hidden { display: none; }
        #status-msg { margin-top: 15px; font-weight: bold; text-align: center; min-height: 24px; }

        /* Example section */
        .example-section { margin-top: 30px; padding: 20px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; max-width: 600px; }
        .example-toggle { background: #6c757d; margin-bottom: 15px; font-size: 14px; }
        .example-content { display: none; }
        .example-content.show { display: block; }
        .example-problem { font-family: 'Courier New', monospace; margin: 15px 0; padding: 15px; background: white; border-left: 3px solid #6c757d; opacity: 0.75; }
        .example-problem h4 { margin: 0 0 10px 0; color: #495057; font-size: 14px; }
        .example-grid { display: grid; grid-template-columns: 40px 40px 40px 10px 40px 40px; gap: 2px; font-size: 18px; margin: 8px 0; }
        .example-cell { width: 40px; height: 30px; display: flex; align-items: center; justify-content: center; border: 1px solid #e0e0e0; background: #fafafa; }
        .example-note { font-size: 12px; color: #666; border: 1px dashed #999; }
        .example-decimal { font-weight: bold; color: #d32f2f; border: none; }
        .example-line { grid-column: 1 / span 6; height: 2px; background: #999; margin: 3px 0; }
        .step-annotation { font-size: 13px; color: #495057; margin: 5px 0; font-style: italic; }
    </style>
</head>
<body>

    <div class="problem-container">
        <div id="instructions" class="instructions">
            <div id="step1">Step 1: <input type="checkbox" id="step1-checkbox" disabled aria-hidden="true"> Use arrows to line up the decimal points.</div>
            <div id="step2" style="opacity:0.5; margin-top:6px;">Step 2: <input type="checkbox" id="step2-checkbox" disabled aria-hidden="true"> Enter the answer (right to left).</div>
            <div style="font-size:12px; margin-top:8px; color:#666;">ðŸ’¡ Tip: Use the dashed boxes above for carries/borrows (optional).</div>
        </div>
        
        <div class="controls">
            <button id="shift-left">â—€ Move 2nd Row</button>
            <button id="shift-right">Move 2nd Row â–¶</button>
        </div>

        <div class="annotation-row" id="annotation-grid">
            <div class="cell no-border"></div>
            <input type="text" class="note-input" id="note_1" maxlength="2" disabled>
            <input type="text" class="note-input" id="note_2" maxlength="2" disabled>
            <div class="decimal-cell"></div>
            <input type="text" class="note-input" id="note_3" maxlength="2" disabled>
            <input type="text" class="note-input" id="note_4" maxlength="2" disabled>
        </div>

        <div class="math-table">
            <div class="cell no-border"></div>
            <div class="cell" id="r1_1"></div>
            <div class="cell" id="r1_2"></div>
            <div class="decimal-cell">.</div>
            <div class="cell" id="r1_3"></div>
            <div class="cell" id="r1_4"></div>

            <div id="row2-wrapper">
                <div class="cell no-border" id="op-display">+</div>
                <div class="cell" id="r2_1"></div>
                <div class="cell" id="r2_2"></div>
                <div class="decimal-cell">.</div>
                <div class="cell" id="r2_3"></div>
                <div class="cell" id="r2_4"></div>
            </div>

            <div class="line"></div>

            <div class="cell no-border"></div>
            <div class="cell no-border"><input type="text" class="digit-input" id="ans_1" maxlength="1" disabled></div>
            <div class="cell no-border"><input type="text" class="digit-input" id="ans_2" maxlength="1" disabled></div>
            <div class="decimal-cell">.</div>
            <div class="cell no-border"><input type="text" class="digit-input" id="ans_3" maxlength="1" disabled></div>
            <div class="cell no-border"><input type="text" class="digit-input" id="ans_4" maxlength="1" disabled></div>
        </div>

        <div id="status-msg"></div>
        <br>
        <button id="next-btn" class="hidden" onclick="generateProblem()">Next Problem</button>
    </div>

    <div class="example-section">
        <button class="example-toggle" onclick="toggleExamples()">ðŸ“– Show Examples: How to Use Borrow/Carry Boxes</button>
        <div id="example-content" class="example-content">
            
            <div class="example-problem">
                <h4>Example 1: Subtraction with Borrowing (60.54 - 08.84)</h4>
                <p class="step-annotation">Step 1: Start from the right (hundredths place): 4 - 4 = 0 âœ“</p>
                <div class="example-grid">
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-note"></div>
                    <div class="example-note"></div>
                    <div class="example-decimal">.</div>
                    <div class="example-note"></div>
                    <div class="example-note"></div>
                    
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell">6</div>
                    <div class="example-cell">0</div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell">5</div>
                    <div class="example-cell">4</div>
                    
                    <div class="example-cell" style="border:none;">-</div>
                    <div class="example-cell">0</div>
                    <div class="example-cell">8</div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell">8</div>
                    <div class="example-cell">4</div>
                    
                    <div class="example-line"></div>
                    
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="background:#e8f5e9;">0</div>
                </div>
                
                <p class="step-annotation">Step 2: Tenths place: 5 - 8? Can't do it! Need to borrow from the 0.</p>
                <p class="step-annotation">â†’ Borrow from ones place (0 becomes -1, but 0 can't give! So borrow from tens: 6â†’5)</p>
                <p class="step-annotation">â†’ The 0 in ones becomes 10, borrow 1 from it â†’ 9 remains in ones place</p>
                <p class="step-annotation">â†’ The 5 in tenths becomes 15. Write <strong>15</strong> above the 5, and <strong>9</strong> above the 0.</p>
                
                <div class="example-grid">
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-note"></div>
                    <div class="example-note" style="background:#fff3cd;">9</div>
                    <div class="example-decimal">.</div>
                    <div class="example-note" style="background:#fff3cd;">15</div>
                    <div class="example-note"></div>
                    
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell">6</div>
                    <div class="example-cell" style="text-decoration:line-through; color:#999;">0</div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell" style="text-decoration:line-through; color:#999;">5</div>
                    <div class="example-cell">4</div>
                    
                    <div class="example-cell" style="border:none;">-</div>
                    <div class="example-cell">0</div>
                    <div class="example-cell">8</div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell">8</div>
                    <div class="example-cell">4</div>
                    
                    <div class="example-line"></div>
                    
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell" style="background:#e8f5e9;">7</div>
                    <div class="example-cell" style="background:#e8f5e9;">0</div>
                </div>
                <p class="step-annotation">Now: 15 - 8 = 7 âœ“</p>
                
                <p class="step-annotation">Step 3: Ones place: 9 - 8 = 1 âœ“</p>
                <p class="step-annotation">Step 4: Tens place: 6 - 0 = 6. But we borrowed 1, so 5 - 0 = 5 âœ“</p>
                <p class="step-annotation"><strong>Final answer: 51.70</strong></p>
            </div>

            <div class="example-problem">
                <h4>Example 2: Addition with Carry (45.67 + 38.58)</h4>
                <p class="step-annotation">Step 1: Hundredths: 7 + 8 = 15. Write 5, carry <strong>1</strong> above next column.</p>
                
                <div class="example-grid">
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-note"></div>
                    <div class="example-note"></div>
                    <div class="example-decimal">.</div>
                    <div class="example-note" style="background:#fff3cd;">1</div>
                    <div class="example-note"></div>
                    
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell">4</div>
                    <div class="example-cell">5</div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell">6</div>
                    <div class="example-cell">7</div>
                    
                    <div class="example-cell" style="border:none;">+</div>
                    <div class="example-cell">3</div>
                    <div class="example-cell">8</div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell">5</div>
                    <div class="example-cell">8</div>
                    
                    <div class="example-line"></div>
                    
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="background:#e8f5e9;">5</div>
                </div>
                
                <p class="step-annotation">Step 2: Tenths: 6 + 5 + 1 (carry) = 12. Write 2, carry <strong>1</strong>.</p>
                
                <div class="example-grid">
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-note"></div>
                    <div class="example-note" style="background:#fff3cd;">1</div>
                    <div class="example-decimal">.</div>
                    <div class="example-note" style="background:#d4edda;">1</div>
                    <div class="example-note"></div>
                    
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell">4</div>
                    <div class="example-cell">5</div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell">6</div>
                    <div class="example-cell">7</div>
                    
                    <div class="example-cell" style="border:none;">+</div>
                    <div class="example-cell">3</div>
                    <div class="example-cell">8</div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell">5</div>
                    <div class="example-cell">8</div>
                    
                    <div class="example-line"></div>
                    
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-cell" style="border:none;"></div>
                    <div class="example-decimal">.</div>
                    <div class="example-cell" style="background:#e8f5e9;">2</div>
                    <div class="example-cell" style="background:#e8f5e9;">5</div>
                </div>
                
                <p class="step-annotation">Step 3: Ones: 5 + 8 + 1 (carry) = 14. Write 4, carry <strong>1</strong>.</p>
                <p class="step-annotation">Step 4: Tens: 4 + 3 + 1 (carry) = 8.</p>
                <p class="step-annotation"><strong>Final answer: 84.25</strong></p>
            </div>

            <div class="example-problem">
                <h4>ðŸ’¡ Quick Rules:</h4>
                <p class="step-annotation"><strong>Borrowing:</strong> When top digit < bottom digit, borrow from the left. Write the new value (original + 10) in the scratch box above. Don't forget to reduce the left digit by 1 (and write that too if needed).</p>
                <p class="step-annotation"><strong>Carrying:</strong> When a column sum â‰¥ 10, write <strong>1</strong> in the scratch box above the next column to the left.</p>
                <p class="step-annotation"><strong>Remember:</strong> These boxes are optional! Use them if they help you track your work.</p>
            </div>
        </div>
    </div>

    <script>
        let solution = "";
        let shiftIndex = 2; // Start unaligned
        const offsetPixels = 42; // Width of cell + gap
        let currentProblem = { n1: "", n2: "", isAdd: true };

        // Expected annotations (optional, for validation feedback only)
        let expectedNotes = { note_1: "", note_2: "", note_3: "", note_4: "" };

        function calculateAnnotations(n1, n2, isAdd) {
            const d1 = n1.replace('.', '').split('').map(Number);
            const d2 = n2.replace('.', '').split('').map(Number);
            let notes = { note_1: "", note_2: "", note_3: "", note_4: "" };

            if (isAdd) {
                let carry = 0;
                // iterate from rightmost (idx 3) toward left (idx 1)
                for (let i = 3; i >= 1; i--) {
                    const sum = d1[i] + d2[i] + carry;
                    if (sum >= 10) {
                        carry = 1;
                        // carry should be written above the column to the left
                        // e.g. carry from idx=3 -> note_3 (above idx=2)
                        notes[`note_${i}`] = "1";
                    } else {
                        carry = 0;
                    }
                }
            } else {
                // Subtraction borrowing logic: show regrouped values
                let borrowed = d1.slice();
                for (let i = 3; i >= 1; i--) {
                    if (borrowed[i] < d2[i]) {
                        borrowed[i] += 10;
                        borrowed[i - 1] -= 1;
                        // Show the new borrowed value in the current column's note
                        // and the updated left digit in its note
                        notes[`note_${i + 1}`] = borrowed[i].toString();
                        notes[`note_${i}`] = borrowed[i - 1].toString();
                    }
                }
            }

            return notes;
        }

        function generateProblem() {
            shiftIndex = Math.random() > 0.5 ? 1 : -1; 
            updateShiftUI();
            
            const isAdd = Math.random() > 0.5;
            let n1 = (Math.random() * 80 + 10).toFixed(2);
            let n2 = (Math.random() * 10 + 5).toFixed(2);
            
            if (!isAdd && parseFloat(n1) < parseFloat(n2)) [n1, n2] = [n2, n1];
            
            let res = isAdd ? (parseFloat(n1) + parseFloat(n2)) : (parseFloat(n1) - parseFloat(n2));
            solution = res.toFixed(2).padStart(5, '0').replace('.', ''); // e.g. "45.20" -> "4520"

            currentProblem = { n1, n2, isAdd };
            document.getElementById('op-display').innerText = isAdd ? '+' : '-';
            fillRow('r1', n1);
            fillRow('r2', n2);

            // Clear any borrowed styling from previous problem
            document.querySelectorAll('.cell').forEach(cell => cell.classList.remove('borrowed'));

            // calculate expected annotations (for optional validation)
            expectedNotes = calculateAnnotations(n1, n2, isAdd);
            document.querySelectorAll('.note-input').forEach(input => {
                input.value = '';
                input.className = 'note-input';
                input.disabled = true; // enabled after alignment (step 1)
            });
            // remove active marking - annotations are now optional
            document.querySelectorAll('.note-input').forEach(el => {
                el.classList.remove('active');
            });

            // Reset inputs
            document.querySelectorAll('.digit-input').forEach(input => {
                input.value = '';
                input.className = 'digit-input';
                input.disabled = true;
            });
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('status-msg').innerText = "";
            // Reset step indicators
            const step1cb = document.getElementById('step1-checkbox');
            step1cb.checked = false;
            const step2cb = document.getElementById('step2-checkbox');
            step2cb.checked = false;
            document.getElementById('step2').style.opacity = 0.5;
        }

        function fillRow(prefix, num) {
            const parts = num.split('.');
            const whole = parts[0].padStart(2, '0');
            const dec = parts[1].padEnd(2, '0');
            document.getElementById(`${prefix}_1`).innerText = whole[0];
            document.getElementById(`${prefix}_2`).innerText = whole[1];
            document.getElementById(`${prefix}_3`).innerText = dec[0];
            document.getElementById(`${prefix}_4`).innerText = dec[1];
        }

        function updateShiftUI() {
            const wrapper = document.getElementById('row2-wrapper');
            wrapper.style.transform = `translateX(${shiftIndex * offsetPixels}px)`;
            
            if (shiftIndex === 0) {
                // Mark Step 1 as complete and enable Step 2
                document.getElementById('step1-checkbox').checked = true;
                document.getElementById('step2').style.opacity = 1;
                
                // Enable both note inputs (optional) and digit inputs simultaneously
                document.querySelectorAll('.note-input, .digit-input').forEach(i => {
                    i.disabled = false;
                    i.classList.remove('incorrect', 'correct');
                });
                
                // Focus rightmost answer input to encourage right-to-left flow
                const rightmost = document.getElementById('ans_4');
                if (rightmost) rightmost.focus();
            } else {
                // Uncheck Step 1 and dim Step 2 while aligning
                document.getElementById('step1-checkbox').checked = false;
                document.getElementById('step2').style.opacity = 0.5;
                document.querySelectorAll('.note-input').forEach(i => { i.disabled = true; i.className = 'note-input'; });
                document.querySelectorAll('.digit-input').forEach(i => i.disabled = true);
            }
        }

        document.getElementById('shift-left').onclick = () => { shiftIndex--; updateShiftUI(); };
        document.getElementById('shift-right').onclick = () => { shiftIndex++; updateShiftUI(); };

        document.querySelectorAll('.digit-input').forEach((input, idx) => {
            input.addEventListener('input', (e) => {
                const val = e.target.value;
                const correctDigit = solution[idx];

                if (val === "") {
                    input.className = 'digit-input';
                } else if (val === correctDigit) {
                    input.className = 'digit-input correct';
                    checkTotalWin();
                } else {
                    input.className = 'digit-input incorrect';
                }
            });
        });

        // Note input validation: optional, non-blocking feedback
        document.querySelectorAll('.note-input').forEach((input) => {
            input.addEventListener('input', (e) => {
                // allow only digits, up to maxlength
                e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 2);
                validateNote(e.target);
                updateBorrowVisuals(e.target);
            });
        });

        function updateBorrowVisuals(noteInput) {
            // Strike through the corresponding r1 cell when a borrow/carry is written
            const noteId = noteInput.id; // e.g., note_1, note_2, note_3, note_4
            const digitIndex = noteId.split('_')[1]; // 1, 2, 3, or 4
            const r1Cell = document.getElementById(`r1_${digitIndex}`);
            
            if (r1Cell) {
                if (noteInput.value !== "") {
                    r1Cell.classList.add('borrowed');
                } else {
                    r1Cell.classList.remove('borrowed');
                }
            }
        }

        function validateNote(input) {
            const id = input.id; // note_1 .. note_4
            const expected = expectedNotes[id] || "";
            const val = input.value;

            if (val === "") {
                input.className = 'note-input';
            } else if (expected !== "" && val === expected) {
                input.className = 'note-input correct';
            } else if (expected !== "") {
                input.className = 'note-input incorrect';
            } else {
                // No expected value for this position
                input.className = 'note-input incorrect';
            }
        }

        function checkTotalWin() {
            const inputs = document.querySelectorAll('.digit-input');
            const allCorrect = Array.from(inputs).every((input, idx) => input.value === solution[idx]);
            if (allCorrect) {
                document.getElementById('status-msg').innerText = "Correct! Balance updated. ðŸŒŸ";
                document.getElementById('next-btn').classList.remove('hidden');
                document.getElementById('step2-checkbox').checked = true;
                // Disable all inputs after correct answer
                document.querySelectorAll('.digit-input, .note-input').forEach(i => i.disabled = true);
            }
        }

        function toggleExamples() {
            const content = document.getElementById('example-content');
            const button = document.querySelector('.example-toggle');
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                button.innerText = 'ðŸ“– Show Examples: How to Use Borrow/Carry Boxes';
            } else {
                content.classList.add('show');
                button.innerText = 'ðŸ“– Hide Examples';
            }
        }

        generateProblem();
    </script>
</body>
</html>